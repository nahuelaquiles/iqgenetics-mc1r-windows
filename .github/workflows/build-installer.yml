name: Build Windows Installer

on:
  workflow_dispatch:
  push:
    tags:
      - "v*"

jobs:
  build:
    runs-on: windows-latest
    defaults:
      run:
        shell: pwsh

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Restore
        run: dotnet restore

      - name: Publish self-contained app (win-x64)
        run: |
          dotnet publish .\src\IQGenetics.MC1R.App\IQGenetics.MC1R.App.csproj `
            -c Release -r win-x64 --self-contained true `
            /p:PublishSingleFile=true `
            /p:IncludeNativeLibrariesForSelfExtract=true `
            /p:PublishTrimmed=false `
            -o .\artifacts\publish

      - name: Build MSI (WiX v4)
        run: |
          dotnet build .\build\installer\IQGenetics.MC1R.Installer.wixproj `
            -c Release `
            /p:PublishDir=$((Resolve-Path .\artifacts\publish).Path)

      - name: Copy MSI to artifacts
        run: |
          New-Item -ItemType Directory -Force -Path .\artifacts\installer | Out-Null
          Copy-Item .\build\installer\bin\Release\*.msi .\artifacts\installer\ -Force

      - name: Upload installer artifact
        uses: actions/upload-artifact@v4
        with:
          name: IQGenetics_MC1R_Installer
          path: artifacts/installer/*.msi
