name: Build Windows Installer

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NETÂ 8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Restore
        run: dotnet restore
        shell: pwsh

      - name: Publish app (self-contained win-x64)
        run: |
          New-Item -ItemType Directory -Force -Path artifacts\publish | Out-Null
          dotnet publish .\src\IQGenetics.MC1R\IQGenetics.MC1R.csproj `
            -c Release `
            -r win-x64 `
            --self-contained true `
            -o .\artifacts\publish
        shell: pwsh

      - name: Resolve PublishDir for WiX
        id: vars
        run: |
          $p = (Resolve-Path .\artifacts\publish).Path
          $p = $p.Replace('\','/')
          if (-not $p.EndsWith('/')) { $p = $p + '/' }
          "publishDir=$p" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          Write-Host "PublishDir passed to WiX: $p"
        shell: pwsh

      - name: Build WiX MSI
        run: |
          dotnet build .\build\installer\IQGenetics.MC1R.Installer.wixproj `
            -c Release `
            /p:PublishDir=${{ steps.vars.outputs.publishDir }} `
            /p:InstallerPlatform=x64
        shell: pwsh

      - name: List produced MSI
        run: |
          Get-ChildItem -Recurse -Path .\artifacts\installer -Filter *.msi | Format-Table FullName, Length
        shell: pwsh

      - name: Upload MSI artifact
        uses: actions/upload-artifact@v4
        with:
          name: IQGenetics_MC1R_Installer
          path: artifacts/installer/**/*.msi
          if-no-files-found: error
